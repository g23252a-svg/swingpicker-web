import streamlit as st
import pandas as pd
import datetime as dt
import pytz
import math
import time
from pykrx import stock
from concurrent.futures import ThreadPoolExecutor, as_completed

# ---------------- ê¸°ë³¸ ì„¤ì • ----------------
st.set_page_config(page_title="Swing Picker Web v3.0.3 (LDY Edition)", layout="wide")

st.title("ğŸ“ˆ Swing Picker Web v3.0.3 (KST Fix Â· LDY Edition)")
st.write("ê±°ë˜ëŒ€ê¸ˆ + ê¸°ìˆ ì§€í‘œ ê¸°ë°˜ ìë™ ìŠ¤ìœ™ ì¢…ëª© ì¶”ì²œ (í•œêµ­ì‹œê°„ ëŒ€ì‘íŒ)")

DEFAULTS = {
    "MARKETS": ["KOSPI", "KOSDAQ"],
    "TOP_TURNOVER": 120,
    "TOP_N": 10,
    "LOOKBACK_DAYS": 63,
    "VOL_RATIO_MIN": 1.5,
    "RET5_MAX": 8.0,
    "RET10_MAX": 15.0,
    "EXCLUDE_HARD_DROP": True,
    "HARD_DROP_5D": -10.0,
    "REQUEST_DELAY_SEC": 0.22,
    "MAX_WORKERS": 6,
}

KST = pytz.timezone("Asia/Seoul")

# ---------------- ìœ í‹¸ ----------------
def last_trading_day_kst(use_yesterday: bool = True):
    """í•œêµ­ì‹œê°„ ê¸°ì¤€ìœ¼ë¡œ ì „ì¼/ê¸ˆì¼ ê±°ë˜ì¼ ë°˜í™˜"""
    now = dt.datetime.now(KST)
    if use_yesterday:
        target = now - dt.timedelta(days=1)
    else:
        if now.hour < 16:
            target = now - dt.timedelta(days=1)
        else:
            target = now
    while target.weekday() >= 5:
        target -= dt.timedelta(days=1)
    return target.strftime("%Y%m%d")

def normalize_ohlcv_columns(df: pd.DataFrame):
    m = {"open": "ì‹œê°€", "high": "ê³ ê°€", "low": "ì €ê°€", "close": "ì¢…ê°€", "volume": "ê±°ë˜ëŸ‰", "amount": "ê±°ë˜ëŒ€ê¸ˆ"}
    cols = {c: c for c in df.columns}
    for c in df.columns:
        lc = str(c).lower()
        for k, v in m.items():
            if k in lc:
                cols[c] = v
                break
    df = df.rename(columns=cols)
    if "ê±°ë˜ëŒ€ê¸ˆ" not in df.columns and {"ì¢…ê°€", "ê±°ë˜ëŸ‰"}.issubset(df.columns):
        df["ê±°ë˜ëŒ€ê¸ˆ"] = df["ì¢…ê°€"] * df["ê±°ë˜ëŸ‰"]
    return df

def get_top_turnover_stocks(end, markets, top_turnover):
    all_df = []
    for m in markets:
        df = stock.get_market_ohlcv_by_ticker(end, market=m)
        df = normalize_ohlcv_columns(df)
        df["ì‹œì¥"] = m
        all_df.append(df)
        time.sleep(DEFAULTS["REQUEST_DELAY_SEC"])
    df_all = pd.concat(all_df)
    df_all["ê±°ë˜ëŒ€ê¸ˆ(ì–µ)"] = df_all["ê±°ë˜ëŒ€ê¸ˆ"] / 1e8
    return df_all.sort_values("ê±°ë˜ëŒ€ê¸ˆ(ì–µ)", ascending=False).head(int(top_turnover))

def rsi_series(close: pd.Series, period=14):
    delta = close.diff()
    up = delta.clip(lower=0)
    down = -delta.clip(upper=0)
    roll_up = up.ewm(alpha=1/period, adjust=False).mean()
    roll_down = down.ewm(alpha=1/period, adjust=False).mean().replace(0, 1e-9)
    rs = roll_up / roll_down
    return 100 - (100 / (1 + rs))

def macd_series(close: pd.Series, fast=12, slow=26, signal=9):
    ema_fast = close.ewm(span=fast, adjust=False).mean()
    ema_slow = close.ewm(span=slow, adjust=False).mean()
    macd = ema_fast - ema_slow
    sig = macd.ewm(span=signal, adjust=False).mean()
    hist = macd - sig
    return macd, sig, hist

def analyze_stock(df: pd.DataFrame, code: str, name: str):
    if df is None or len(df) < 40:
        return None
    try:
        c = df["ì¢…ê°€"].astype(float)
        o = df["ì‹œê°€"].astype(float)
        v = df["ê±°ë˜ëŸ‰"].astype(float)
        ret5 = c.pct_change(5).iloc[-1] * 100
        ret10 = c.pct_change(10).iloc[-1] * 100
        v20 = v.iloc[-20:].mean()
        vr = (v.iloc[-3:].mean() / v20) if v20 > 0 else 0.0
        if ret5 < DEFAULTS["HARD_DROP_5D"]:
            return None
        ma20 = c.rolling(20).mean()
        rsi = rsi_series(c, 14).iloc[-1]
        macd, sig, hist = macd_series(c)
        macd_hist = hist.iloc[-1]
        conds = [ret5 <= DEFAULTS["RET5_MAX"], ret10 <= DEFAULTS["RET10_MAX"], vr >= DEFAULTS["VOL_RATIO_MIN"], rsi < 70, macd_hist > 0]
        if all(conds):
            last = c.iloc[-1]
            buy = round(last * 0.98)
            sell = round(last * 1.10)
            return {
                "ì¢…ëª©ëª…": name,
                "ì¢…ëª©ì½”ë“œ": code,
                "í˜„ì¬ê°€": f"{last:,.0f}",
                "ì¶”ì²œë§¤ìˆ˜ê°€": f"{buy:,}",
                "ì¶”ì²œë§¤ë„ê°€": f"{sell:,}",
                "5ì¼ìˆ˜ìµë¥ (%)": f"{ret5:.2f}",
                "10ì¼ìˆ˜ìµë¥ (%)": f"{ret10:.2f}",
                "ê±°ë˜ëŸ‰ë°°ìˆ˜": f"{vr:.2f}",
                "RSI14": f"{rsi:.1f}",
                "MACD_hist": f"{macd_hist:.4f}",
            }
    except Exception:
        return None
    return None

# ---------------- Streamlit UI ----------------
col1, col2 = st.columns(2)
with col1:
    top_turnover = st.number_input("ê±°ë˜ëŒ€ê¸ˆ ìƒìœ„ N", value=DEFAULTS["TOP_TURNOVER"], min_value=50, max_value=500)
    topn = st.number_input("ì¶”ì²œ ì¢…ëª© ìˆ˜", value=DEFAULTS["TOP_N"], min_value=5, max_value=50)
with col2:
    use_yesterday = st.checkbox("ì „ì¼ ê¸°ì¤€ìœ¼ë¡œ ì¡°íšŒ", value=True)
    lookback = st.number_input("ì¡°íšŒì¼ìˆ˜(LOOKBACK)", value=DEFAULTS["LOOKBACK_DAYS"], min_value=30, max_value=200)

if st.button("ğŸ” ìŠ¤ìº” ì‹œì‘"):
    st.info("ë°ì´í„° ìˆ˜ì§‘ ë° ë¶„ì„ ì¤‘... (1~3ë¶„ ì†Œìš”)")
    end = last_trading_day_kst(use_yesterday)
    start = (dt.datetime.strptime(end, "%Y%m%d") - dt.timedelta(days=int(lookback))).strftime("%Y%m%d")
    top_df = get_top_turnover_stocks(end, DEFAULTS["MARKETS"], top_turnover)
    codes = list(top_df.index)
    name_map = {c: stock.get_market_ticker_name(c) for c in codes}

    results = []
    with ThreadPoolExecutor(max_workers=DEFAULTS["MAX_WORKERS"]) as ex:
        fut = {ex.submit(stock.get_market_ohlcv_by_date, start, end, c): c for c in codes}
        for f in as_completed(fut):
            code = fut[f]
            try:
                df2 = normalize_ohlcv_columns(f.result())
                res = analyze_stock(df2, code, name_map.get(code, code))
                if res:
                    results.append(res)
            except Exception:
                pass

    if results:
        df_res = pd.DataFrame(results).head(topn)
        st.success(f"âœ… ë¶„ì„ ì™„ë£Œ! ì¶”ì²œ ì¢…ëª© {len(df_res)}ê°œ ë°œê²¬")
        st.dataframe(df_res, use_container_width=True)
    else:
        st.warning("âš ï¸ ì¡°ê±´ì— ë§ëŠ” ì¢…ëª©ì´ ì—†ìŠµë‹ˆë‹¤.")

# ---------------- í‘¸í„° (ë¸Œëœë”©) ----------------
st.markdown(
    """
    <div style='text-align: right; color: gray; font-size: 14px; margin-top: 25px;'>
        Made by <b>LDY</b> â€” Swing Picker Web Â© 2025
    </div>
    """,
    unsafe_allow_html=True
)
